zoop_stations<-as.data.frame(zoop_stations)
zoop_stations_geom<-st_as_sf(zoop_stations,coords = c("Longitude", "Latitude"),remove = TRUE, crs = 4326)
p<-ggplot()+
geom_sf(data=stratum,aes(fill=SubRegion))+
geom_sf(data=spacetools::Delta)+
geom_sf(data = zoop_stations_geom$geometry, size = 2,
shape = 23, fill = "green")+
theme(legend.position = "none")
p
ggsave("Figures/station_subregions.png")
station_subregions<-st_join(zoop_stations_geom,stratum,join = st_within)
st_geometry(station_subregions)<-NULL
station_subregions<-unique((dplyr::select(station_subregions,Source,Station,SubRegion)))
#join in new subregion station assignments to the Zoop_BPUE dataframe
Zoop_BPUE_regions<-Zoop_BPUE%>%inner_join(station_subregions)
Zoop_BPUE_ez_regions<-Zoop_BPUE%>%inner_join(ez_subregions)
Zoop_BPUE<-Zoop_BPUE_regions%>%rbind(Zoop_BPUE_ez_regions)
Zoop_BPUE$water_year<-wtr_yr(Zoop_BPUE$Date)
#assign month and years
Zoop_BPUE$month<-as.numeric(format(as.Date(Zoop_BPUE$Date), "%m"))
Zoop_BPUE$year<-as.numeric(format(as.Date(Zoop_BPUE$Date), "%Y"))
#################################
#FLOAT Long term analysis (1975-2010,EMP)
#################################
#filter for target metrics
Zoop_LT<-Zoop_BPUE%>%
filter(Source=="EMP",water_year<2011,Taxlifestage%in%target_FLOAT_taxa)
#first calc total BPUE for each sample
Zoop_sample_totals<-Zoop_LT%>%group_by(Station,Date,SubRegion,water_year,month)%>%
dplyr::summarise(totalBPUE=sum(BPUE))
#calculate monthly average totalBPUE
Zoop_BPUE_monthly_average<-Zoop_sample_totals%>%
group_by(water_year,month,SubRegion)%>%
dplyr::summarise(month_BPUE=mean(totalBPUE))
#calculate seasonal averages for each subregion
month<-c(1,2,3,4,5,6,7,8,9,10,11,12)
Season<-c("Winter","Winter","Spring","Spring","Spring","Summer","Summer","Summer","Fall","Fall","Fall","Winter")
szn_mnth<-data.frame(month,Season)
szn_mnth$Season<-factor(szn_mnth$Season,levels=c("Winter","Spring","Summer","Fall"))
Zoop_BPUE_monthly_average<-Zoop_BPUE_monthly_average%>%inner_join(szn_mnth)
Zoop_BPUE_szn_avg<-Zoop_BPUE_monthly_average%>%group_by(Season,water_year,SubRegion)%>%
dplyr::summarise(szn_BPUE=mean(month_BPUE))
#drop regions not in fall low_sal zone or long-term analysis lists
sams_table<-read.csv("Data/Low_salinity_zone.csv")
sams_table$water_year<-sams_table$Year
Zoop_BPUE_szn_avg<-Zoop_BPUE_szn_avg%>%inner_join(sams_table)#inner join narrows to just low_sal_zone
Zoop_FLOAT_LT<-Zoop_BPUE_szn_avg%>%
filter(Long_term=="TRUE")
#calculate year szn average across subregions
Zoop_FLOAT_LT<-Zoop_FLOAT_LT%>%
group_by(water_year,Season)%>%
dplyr::summarise(szn_BPUE=mean(szn_BPUE))
Zoop_FLOAT_LT<-dplyr::rename(Zoop_FLOAT_LT,BPUE_ug=szn_BPUE)
#Taxa break down
taxa<-Zoop_LT%>%group_by(Station,Date,SubRegion,water_year,month,Taxlifestage)%>%
dplyr::summarise(totalBPUE=sum(BPUE))
#calculate monthly average totalBPUE
taxa<-taxa%>%
group_by(water_year,month,SubRegion,Taxlifestage)%>%
dplyr::summarise(month_BPUE=mean(totalBPUE))
taxa<-taxa%>%inner_join(szn_mnth)
taxa<-taxa%>%group_by(Season,water_year,SubRegion,Taxlifestage)%>%
dplyr::summarise(szn_BPUE=mean(month_BPUE))
taxa<-taxa%>%inner_join(sams_table)#inner join narrows to just low_sal_zone
taxa<-taxa%>%
filter(Long_term=="TRUE")
#calculate year szn average across subregions
taxa<-taxa%>%
group_by(water_year,Season,Taxlifestage)%>%
dplyr::summarise(szn_BPUE=mean(szn_BPUE))
taxa<-dplyr::rename(taxa,BPUE_ug=szn_BPUE)
p<-ggplot(taxa,aes(water_year,BPUE_ug,fill=Taxlifestage))+
geom_bar(stat="identity")+
facet_wrap(~Season)
p
ggsave("Figures/FLOAT_BPUE_Taxa.png")
##############################
#FLOAT Short-term analysis (2010-2020, EMP, FMWT, STN, 20mm)
##############################
Zoop_ST<-Zoop_BPUE%>%
filter(water_year>2009,Taxlifestage%in%target_FLOAT_taxa)
Zoop_ST_totals<-Zoop_ST%>%group_by(Station,Date,SubRegion,water_year,month)%>%
dplyr::summarise(totalBPUE=sum(BPUE))
#calc monthly subregion averages
Zoop_ST_m<-Zoop_ST_totals%>%
group_by(SubRegion,water_year,month)%>%
dplyr::summarise(month_BPUE=mean(totalBPUE))
#calc seasonal averages for each Subregion
Zoop_ST_s<-Zoop_ST_m%>%inner_join(szn_mnth)
Zoop_ST_s<-Zoop_ST_s%>%
group_by(Season,water_year,SubRegion)%>%
dplyr::summarise(season_BPUE=mean(month_BPUE))
#drop regions not in Sams table
Zoop_ST_s<-Zoop_ST_s%>%inner_join(sams_table)%>%
filter(water_year>2009, Short_term==TRUE)
Zoop_FLOAT_ST<-Zoop_ST_s%>%
group_by(water_year,Season)%>%
dplyr::summarise(szn_BPUE=mean(season_BPUE))
Zoop_FLOAT_ST<-dplyr::rename(Zoop_FLOAT_ST,BPUE_ug=szn_BPUE)
#################################
#DROUGHT BPUE Long term analysis (1975-2021,EMP)
#################################
rosies_table<-read.csv("Data/Rosies_regions.csv",fileEncoding="UTF-8-BOM")
Drought_LT<-Zoop_BPUE%>%
filter(Taxlifestage%in%target_DROUGHT_taxa)
Drought_LT<-Drought_LT%>%inner_join(rosies_table)
#first calc total BPUE for each sample
Drought_LT_t<-Drought_LT%>%group_by(Station,Date,Long_term,Region,water_year,month)%>%
dplyr::summarise(totalBPUE=sum(BPUE))
Drought_LT_t<-Drought_LT_t%>%
inner_join(szn_mnth)
Drought_LT_monthly_average<-Drought_LT_t%>%
group_by(water_year,month,Long_term,Region,Season)%>%
dplyr::summarise(month_BPUE=mean(totalBPUE))
Drought_LT_m<-Drought_LT_monthly_average%>%
filter(Long_term==TRUE)
#calculate seasonal averages
Drought_LT_s<-Drought_LT_m%>%
group_by(water_year,Long_term,Region,Season)%>%
dplyr::summarise(s_BPUE=mean(month_BPUE))
Zoop_Drought_LT<-Drought_LT_s%>%
group_by(Season,water_year)%>%
dplyr::summarise(szn_BPUE=mean(s_BPUE))
Zoop_Drought_LT<-dplyr::rename(Zoop_Drought_LT,BPUE_ug=szn_BPUE)
Zoop_Drought_LT<-Zoop_Drought_LT%>%
group_by(water_year)%>%
dplyr::summarise(BPUE_ug=mean(BPUE_ug))
#Taxa break down
taxa<-Drought_LT%>%group_by(Station,Date,Long_term,Region,water_year,month,Taxlifestage)%>%
dplyr::summarise(totalBPUE=sum(BPUE))
#calculate monthly average totalBPUE
taxa<-taxa%>%
group_by(water_year,month,Long_term,Region,Taxlifestage)%>%
dplyr::summarise(month_BPUE=mean(totalBPUE))
taxa<-taxa%>%inner_join(szn_mnth)
taxa<-taxa%>%group_by(Season,water_year,Long_term,Region,Taxlifestage)%>%
dplyr::summarise(szn_BPUE=mean(month_BPUE))
taxa<-taxa%>%
filter(Long_term=="TRUE")
#calculate year szn average across subregions
taxa<-taxa%>%
group_by(water_year,Season,Taxlifestage)%>%
dplyr::summarise(szn_BPUE=mean(szn_BPUE))
taxa<-dplyr::rename(taxa,BPUE_ug=szn_BPUE)
taxa<-taxa%>%group_by(water_year,Taxlifestage)%>%
dplyr::summarise(BPUE_ug=mean(BPUE_ug))
p<-ggplot(taxa,aes(water_year,BPUE_ug,fill=Taxlifestage))+
geom_bar(stat="identity")
p
ggsave("Figures/DROUGHT_BPUE_Taxa.png")
#create joint wide matrix
Drought_LT_matrix<-Zoop_Drought_LT
Drought_LT_matrix$Taxlifestage<-"All taxa"
Drought_LT_matrix<-Drought_LT_matrix%>%
rbind(taxa)
Drought_LT_matrix<-Drought_LT_matrix%>%pivot_wider(names_from=Taxlifestage,values_from=BPUE_ug)
write.csv(Drought_LT_matrix,"Outputs/Drought_taxa_BPUEmatrix.csv",row.names = F)
#################################
#DROUGHT CPUE Long term analysis (1975-2010,EMP)
#this is count and not biomass estimates
#################################
Drought_LT_CPUE<-Zoop_data%>%
filter(Taxlifestage%in%target_DROUGHT_taxa)
Drought_LT_CPUE$month<-as.numeric(format(as.Date(Drought_LT_CPUE$Date), "%m"))
Drought_LT_CPUE$year<-as.numeric(format(as.Date(Drought_LT_CPUE$Date), "%Y"))
Drought_LT_CPUE<-Drought_LT_CPUE%>%inner_join(szn_mnth)
Drought_LT_CPUE$water_year<-wtr_yr(Drought_LT_CPUE$Date)
Drought_LT_CPUE_dist<-Drought_LT_CPUE #set up for distribution
Drought_LT_CPUE<-Drought_LT_CPUE%>% #join in subregions
inner_join(station_subregions)
Drought_LT_CPUE<-Drought_LT_CPUE%>%inner_join(rosies_table)
Drought_LT_CPUE_grouped<-Drought_LT_CPUE%>%group_by(Station,Date,Long_term,Region,water_year,month,Season)%>%
filter(water_year>1974)%>%
dplyr::summarise(totalCPUE=sum(CPUE))
Drought_LT_CPUE2<-Drought_LT_CPUE_grouped%>%
group_by(water_year,month,Long_term,Region,Season)%>%
dplyr::summarise(month_CPUE=mean(totalCPUE))
Drought_LT_CPUE2<-Drought_LT_CPUE2%>%
filter(Long_term==TRUE)
#calculate seasonal averages
Drought_LT_CPUE2<-Drought_LT_CPUE2%>%
group_by(water_year,Long_term,Region,Season)%>%
dplyr::summarise(s_CPUE=mean(month_CPUE))
Zoop_Drought_LT_CPUE2<-Drought_LT_CPUE2%>%
group_by(Season,water_year)%>%
dplyr::summarise(szn_CPUE=mean(s_CPUE))
Zoop_Drought_LT_CPUE2<-Zoop_Drought_LT_CPUE2%>%
group_by(water_year)%>%
dplyr::summarise(szn_CPUE=mean(szn_CPUE))
#################################
#DROUGHT effort
#################################
Effort<-unique(dplyr::select(Drought_LT, Date,Station,Source,SizeClass,Long_term,Region,month,year))
Effort<-Effort%>%inner_join(szn_mnth)
Effort<-Effort%>%filter(Long_term==TRUE)
#Effort<-Effort%>%filter(Source=="EMP")
Effort$Station_Date_Source_SizeClass<-paste(Effort$Station,Effort$Date,Effort$Source,Effort$SizeClass,Effort$Region)
Effort<-Effort%>%
group_by(year,Region,Source,SizeClass)%>%
dplyr::summarize(tows=length(Station_Date_Source_SizeClass))
#################################
#Save all the outputs
#################################
write.csv(Zoop_FLOAT_LT,"Outputs/zoop_float_lt.csv",row.names = F)
write.csv(Zoop_FLOAT_ST,"Outputs/zoop_float_st.csv",row.names = F)
write.csv(Zoop_Drought_LT,"Outputs/zoop_drought_lt.csv",row.names = F)
write.csv(Zoop_Drought_LT_CPUE2,"Outputs/zoop_drought_lt_cpue.csv",row.names = F)
saveRDS(Zoop_FLOAT_LT,"Outputs/zoop_float_lt.rds")
saveRDS(Zoop_FLOAT_ST,"Outputs/zoop_float_st.rds")
saveRDS(Zoop_Drought_LT,"Outputs/zoop_drought_lt.rds")
saveRDS(Zoop_Drought_LT_CPUE2,"Outputs/zoop_drought_lt_cpue.rds")
saveRDS(Drought_LT_CPUE,"Outputs/drought_lt_cpue.rds")
saveRDS(Drought_LT_CPUE_dist,"Outputs/drought_lt_cpue_dist.rds")
saveRDS(Effort,"Outputs/effort.rds")
saveRDS(ez_stations,"Outputs/ez_stations.rds")
saveRDS(zoop_stations,"Outputs/zoopstations.rds")
#load packages
library(tidyverse)
library(tibble)
library(dplyr)
library(ggplot2)
library(plotrix)
library(purrr)
library(cowplot)
library(plyr)
library(readxl)
library(deltamapr)
library(spacetools)
library(sf)
#################################
#DROUGHT Center of distribution metrics
#################################
#dist function
dist_center<-function(data,taxa){
d=data%>%
filter(Taxlifestage==taxa)
d$km_freq<-d$CPUE*d$distance_km
d1<-d%>%
group_by(Survey,seasons,Year,Taxlifestage,Regime)%>%
dplyr::summarize(km_center=sum(km_freq)/sum(CPUE),Mean_X2=mean(X2))
}
ez_stations<-readRDS("Outputs/ez_stations.rds")
zoop_stations<-readRDS("Outputs/zoopstations.rds")
#calculate station distances using spacetools
zoop_stations$Station_ID<-paste(zoop_stations$Source,zoop_stations$Station,sep="_")
ez_stations$Station_ID<-paste(ez_stations$Source,ez_stations$Station,ez_stations$Date,sep="_")
#add in goldengate lat/long
gg_c<-c("Golden_Gate","Golden_Gate","-122.4783","37.8199")
gg_ez<-c("Golden_Gate","Golden_Gate","-122.4783","37.8199","1/1/1999")
zoop_stations<-zoop_stations%>%rbind(gg_c)
ez_stations<-ez_stations%>%rbind(gg_ez)
#station_distances<-Waterdist(Water_map = spacetools::Delta, Points = zoop_stations,
#Latitude_column = Latitude, Longitude_column = Longitude,
#PointID_column = Station_ID)
#ez_distances<-Waterdist(Water_map = spacetools::Delta, Points = ez_stations,
#Latitude_column = Latitude, Longitude_column = Longitude,
#PointID_column = Station_ID)
#saveRDS(station_distances,"Outputs/station_distances.rds")
#saveRDS(ez_distances,"Outputs/ez_distances.rds")
station_distances<-readRDS("Outputs/station_distances.rds")
ez_distances<-readRDS("Outputs/ez_distances.rds")
station_distances_df<-as.data.frame(station_distances)
station_distances_df<-rownames_to_column(station_distances_df,var="Station_ID")
station_distances_df<-dplyr::select(station_distances_df,Station_ID,Golden_Gate)
ez_distances_df<-as.data.frame(ez_distances)
ez_distances_df<-rownames_to_column(ez_distances_df,var="Station_ID")
ez_distances_df<-dplyr::select(ez_distances_df,Station_ID,Golden_Gate)
#seperate our Station ID info
station_distances_df$Station_ID<-as.character(station_distances_df$Station_ID)
station_distances_df<-separate(station_distances_df, col=Station_ID,c("Source","Station"),sep="_")
ez_distances_df$Station_ID<-as.character(ez_distances_df$Station_ID)
ez_distances_df<-separate(ez_distances_df, col=Station_ID,c("Source","Station","Date"),sep="_")
#change meters to km
station_distances_df$distance_km<-station_distances_df$Golden_Gate/1000
ez_distances_df$ez_km<-ez_distances_df$Golden_Gate/1000
station_dist<-dplyr::select(station_distances_df,Source,Station,distance_km)
ez_dist<-dplyr::select(ez_distances_df,Source,Station,Date,ez_km)
ez_dist$Date<-as.Date(ez_dist$Date,"%Y-%m-%d")
Drought_LT_dist<-readRDS("Outputs/Drought_LT_CPUE_dist.rds")
#join distances back into Drought dataset
Drought_LT_dist<-Drought_LT_dist%>%
left_join(station_dist)
Drought_LT_dist<-Drought_LT_dist%>%
left_join(ez_dist)
Drought_LT_dist$distance_km<-ifelse(is.na(Drought_LT_dist$distance_km),Drought_LT_dist$ez_km,Drought_LT_dist$distance_km)
Drought_LT_dist<-Drought_LT_dist[complete.cases(Drought_LT_dist$distance_km), ]
test<-Drought_LT_dist%>%filter(Taxlifestage=="Neomysis mercedis Adult")
#lets do total CPUE distribution first
Drought_dist_tot<-Drought_LT_dist%>%group_by(Station,Date,water_year,month,Season,distance_km)%>%
filter(water_year>1974)%>%
dplyr::summarise(totalCPUE=sum(CPUE))
#calculate center of distributions for total CPUE
ddt_grouped<-Drought_dist_tot%>%group_by(Station,distance_km,Date,water_year,month,Season)%>%
filter(water_year>1974)%>%
dplyr::summarise(sumCPUE=sum(totalCPUE))
ddt_grouped<-ddt_grouped%>%
group_by(water_year,month,Season,Station,distance_km)%>%
dplyr::summarise(month_CPUE=mean(sumCPUE))
#ddt_grouped<-ddt_grouped%>%
#inner_join(rosies_table)%>%
#filter(Long_term==TRUE)
#calculate seasonal averages
ddt_grouped<-ddt_grouped%>%
group_by(water_year,Season,Station,distance_km)%>%
dplyr::summarise(s_CPUE=mean(month_CPUE))
ddt_grouped<-ddt_grouped%>%
group_by(Season,water_year,Station,distance_km)%>%
dplyr::summarise(szn_CPUE=mean(s_CPUE))
ddt_grouped<-ddt_grouped%>%
group_by(water_year,Station,distance_km)%>%
dplyr::summarise(yr_CPUE=mean(szn_CPUE))
ddt_grouped$freq<-as.integer(ddt_grouped$yr_CPUE)
ddt_grouped$km_freq<-ddt_grouped$distance_km*ddt_grouped$freq
ddt_total<-ddt_grouped%>%
group_by(water_year)%>%
dplyr::summarise(km_distr=sum(km_freq)/sum(freq))
saveRDS(ddt_total,"Outputs/ddt_total.rds")
#calculate center of distributions for each taxa
ddtaxa<-Drought_LT_dist%>%filter(water_year>1974)
ddtaxa_grouped<-ddtaxa%>%group_by(Station,distance_km,Date,water_year,month,Season,Taxlifestage)%>%
dplyr::summarise(sumCPUE=sum(CPUE))
ddtaxa_grouped<-ddtaxa_grouped%>%
group_by(water_year,month,Season,Station,distance_km,Taxlifestage)%>%
dplyr::summarise(month_CPUE=mean(sumCPUE))
#ddtaxa_grouped<-ddtaxa_grouped%>%
#inner_join(rosies_table)%>%
#filter(Long_term==TRUE)
#calculate seasonal averages
ddtaxa_grouped<-ddtaxa_grouped%>%
group_by(water_year,Season,Station,distance_km,Taxlifestage)%>%
dplyr::summarise(s_CPUE=mean(month_CPUE))
ddtaxa_grouped<-ddtaxa_grouped%>%
group_by(Season,water_year,Station,distance_km,Taxlifestage)%>%
dplyr::summarise(szn_CPUE=mean(s_CPUE))
ddtaxa_grouped<-ddtaxa_grouped%>%
group_by(Season,water_year,Taxlifestage,Station,distance_km)%>%
dplyr::summarise(yr_CPUE=mean(szn_CPUE))
ddtaxa_grouped$freq<-as.integer(ddtaxa_grouped$yr_CPUE)
ddtaxa_grouped$freq<-ifelse(ddtaxa_grouped$yr_CPUE>0 & ddtaxa_grouped$yr_CPUE<1,1,ddtaxa_grouped$freq)
ddtaxa_grouped$km_freq<-ddtaxa_grouped$distance_km*ddtaxa_grouped$freq
ddtaxa_total<-ddtaxa_grouped%>%
group_by(water_year,Taxlifestage)%>%
dplyr::summarise(km_distr=sum(km_freq)/sum(freq))
saveRDS(ddtaxa_total,"Outputs/ddtaxa_total.rds")
#make one matrix with totals and taxa specific distribution values
distribution_matrix<-ddt_total
distribution_matrix$Taxlifestage<-"All Taxa"
distribution_matrix<-distribution_matrix%>%rbind(ddtaxa_total)
saveRDS(distribution_matrix,"Outputs/distribution_matrix.rds")
distribution_matrix_flat<-distribution_matrix%>%pivot_wider(names_from=Taxlifestage,values_from=km_distr)
write.csv(distribution_matrix_flat,"Outputs/distribution_matrix.csv",row.names = F)
#FLOAT-MAST metric figures
library(tidyr)
library(dplyr)
library(ggplot2)
Zoop_FLOAT_LT<-readRDS("Outputs/zoop_float_lt.rds")
Zoop_FLOAT_ST<-readRDS("Outputs/zoop_float_st.rds")
Zoop_Drought_LT<-readRDS("Outputs/zoop_drought_lt.rds")
Zoop_Drought_LT_CPUE<-readRDS("Outputs/zoop_drought_lt_cpue.rds")
Effort<-readRDS("Outputs/effort.rds")
Zoop_FLOAT_LT$Analysis<-"FLOAT_LT_BPUE"
Zoop_FLOAT_ST$Analysis<-"FLOAT_ST_BPUE"
Zoop_Drought_LT$Analysis<-"Drought_LT_BPUE"
Zoop_Drought_LT_CPUE$Analysis<-"Drought_LT_CPUE"
Zoop_FLOAT_LT$metric<-Zoop_FLOAT_LT$BPUE_ug
Zoop_FLOAT_ST$metric<-Zoop_FLOAT_ST$BPUE_ug
Zoop_Drought_LT$metric<-Zoop_Drought_LT$BPUE_ug
Zoop_Drought_LT_CPUE$metric<-Zoop_Drought_LT_CPUE$szn_CPUE
all_metrics<-Zoop_FLOAT_LT%>%
rbind(Zoop_FLOAT_ST)%>%
rbind(Zoop_Drought_LT)%>%
rbind(Zoop_Drought_LT_CPUE)
all_metrics$Season<-factor(all_metrics$Season,levels = c("Winter","Spring","Summer","Fall"))
all_metrics$Year_Season<-paste(all_metrics$water_year,all_metrics$Season,sep=" ")
p<-ggplot(all_metrics,aes(water_year,metric))+
geom_bar(stat="identity")+
theme_classic()+theme(axis.text.x=element_text(angle=90,size=8))+
facet_wrap(Analysis~.,nrow=4,scales ="free_y")
p
ggsave("Figures/all_metrics.png")
#Effort figures
size_types<-c("Macro","Meso")
szn<-c("Winter","Spring","Summer","Fall")
plot_list<-list()
for(i in 1:2){
target_size<-size_types[i]
d=Effort%>%
filter(SizeClass==target_size)
d2<-d
p<-ggplot(d2,aes(year,Region))+
geom_tile(aes(fill=tows))+
theme_classic()+
theme(axis.text.x=element_text(angle=90,size=10),axis.text.y = element_text(size=10),legend.position = "none")+
scale_fill_gradient(low="white",high="red")+
geom_text(aes(label=round(tows,1)),size=4)+
guides(colour=F)+
ggtitle(paste(target_size,"Sampling Coverage",sep=" "))+
facet_grid(Source~.)
p
ggsave(paste("Figures/",target_size,".png",sep=""),width=18,height=8)
}
#distribution figures
dist_matrix<-readRDS("Outputs/distribution_matrix.rds")
taxa_list<-unique(dist_matrix$Taxlifestage)
#szn<-unique(dist_matrix$Season)
for(i in 1:length(taxa_list)){
d<-dist_matrix%>%
filter(Taxlifestage==taxa_list[i])
d2<-d
p<-ggplot(d2,aes(water_year,km_distr))+
annotate("rect",ymin=30,ymax=42,xmin=1970,xmax=max(d2$water_year+1),alpha=.3,fill="blue")+
annotate("rect",ymin=42,ymax=56,xmin=1970,xmax=max(d2$water_year+1),alpha=.3,fill="green")+
annotate("rect",ymin=56,ymax=75,xmin=1970,xmax=max(d2$water_year+1),alpha=.3,fill="yellow")+
annotate("rect",ymin=75,ymax=90,xmin=1970,xmax=max(d2$water_year+1),alpha=.3,fill="orange")+
annotate("rect",ymin=90,ymax=105,xmin=1970,xmax=max(d2$water_year+1),alpha=.3,fill="red")+
annotate("rect",ymin=105,ymax=140,xmin=1970,xmax=max(d2$water_year+1),alpha=.3,fill="purple")+
annotate("text", y = 36, x = 1972, label = "San Pablo \n Bay",size=3)+
annotate("text", y = 49, x = 1972, label = "Carquinez \n Strait",size=3)+
annotate("text", y = 66, x = 1972, label = "Suisun",size=3)+
annotate("text", y = 82, x = 1972, label = "West \n Delta",size=3)+
annotate("text", y = 98, x = 1972, label = "Central Delta",size=3)+
annotate("text", y = 122, x = 1972, label = "East Delta",size=3)+
geom_point()+
geom_vline(xintercept=d2$water_year, linetype="dashed",
color = "red", size=.2)+
scale_y_continuous(expand = c(0, 0),limits=c(30,140),breaks = round(seq(from=30,
to=140,
by = 10),1))+
scale_x_continuous(expand = c(0, 0),limits=c(1970,2021),breaks = round(seq(from=1970,
to=2021,
by = 5),1))+
ggtitle(paste(taxa_list[i],"Annual center of distribution",sep=" "))+
xlab("Year") + ylab("Center of distribution (km)")+
coord_flip()
p
ggsave(paste("Figures/distributions/",taxa_list[i],".png",sep=""))
}
#Taxa break down
taxa<-Drought_LT%>%group_by(Station,Date,Long_term,Region,water_year,month,Taxlifestage)%>%
dplyr::summarise(totalBPUE=sum(BPUE))
View(taxa)
#calculate monthly average totalBPUE
taxa<-taxa%>%
group_by(water_year,month,Long_term,Region,Taxlifestage)%>%
dplyr::summarise(month_BPUE=mean(totalBPUE))
taxa<-taxa%>%inner_join(szn_mnth)
taxa<-taxa%>%group_by(Season,water_year,Long_term,Region,Taxlifestage)%>%
dplyr::summarise(szn_BPUE=mean(month_BPUE))
taxa<-taxa%>%
filter(Long_term=="TRUE")
#calculate year szn average across subregions
taxa<-taxa%>%
group_by(water_year,Season,Taxlifestage)%>%
dplyr::summarise(szn_BPUE=mean(szn_BPUE))
taxa<-dplyr::rename(taxa,BPUE_ug=szn_BPUE)
taxa<-taxa%>%group_by(water_year,Taxlifestage)%>%
dplyr::summarise(BPUE_ug=mean(BPUE_ug))
p<-ggplot(taxa,aes(water_year,BPUE_ug,fill=Taxlifestage))+
geom_bar(stat="identity")
p
ggsave("Figures/DROUGHT_BPUE_Taxa.png")
#create joint wide matrix
Drought_LT_matrix<-Zoop_Drought_LT
View(Drought_LT_matrix)
Drought_LT_matrix$Taxlifestage<-"All taxa"
Drought_LT_matrix<-Drought_LT_matrix%>%
rbind(taxa)
#create joint wide matrix
Drought_LT_matrix<-Zoop_Drought_LT
Drought_LT_matrix$Taxlifestage<-"All taxa"
Drought_LT_matrix<-Drought_LT_matrix%>%
rbind(taxa)
Drought_LT_matrix<-dplyr::select(Drought_LT_matrix,water_year,Taxlifestage,BPUE_ug)
Drought_LT_matrix<-Drought_LT_matrix%>%
rbind(taxa)
Drought_LT_matrix<-Drought_LT_matrix%>%pivot_wider(names_from=Taxlifestage,values_from=BPUE_ug)
Drought_LT_matrix<-Drought_LT_matrix%>%filter(water_year<2021)
#create joint wide matrix
Drought_LT_matrix<-Zoop_Drought_LT
Drought_LT_matrix$Taxlifestage<-"All taxa"
Drought_LT_matrix<-dplyr::select(Drought_LT_matrix,water_year,Taxlifestage,BPUE_ug)
Drought_LT_matrix<-Drought_LT_matrix%>%
rbind(taxa)
Drought_LT_matrix<-Drought_LT_matrix%>%filter(water_year<2021)
Drought_LT_matrix<-Drought_LT_matrix%>%pivot_wider(names_from=Taxlifestage,values_from=BPUE_ug)
#create joint wide matrix
Drought_LT_matrix<-Zoop_Drought_LT
Drought_LT_matrix$Taxlifestage<-"All taxa"
Drought_LT_matrix<-dplyr::select(Drought_LT_matrix,water_year,Taxlifestage,BPUE_ug)
Drought_LT_matrix<-Drought_LT_matrix%>%
rbind(taxa)
Drought_LT_matrix<-Drought_LT_matrix%>%filter(water_year<2021)
Drought_LT_matrix$BPUE_ug[Drought_LT_matrix$BPUE_ug == 0] <- NA
Drought_LT_matrix<-Drought_LT_matrix%>%pivot_wider(names_from=Taxlifestage,values_from=BPUE_ug)
write.csv(Drought_LT_matrix,"Outputs/Drought_taxa_BPUEmatrix.csv",row.names = F)
write.csv(Drought_LT_matrix,"Outputs/Drought_taxa_BPUEmatrix.csv",row.names = F)
#create joint wide matrix
Drought_LT_matrix<-Zoop_Drought_LT
Drought_LT_matrix$Taxlifestage<-"All taxa"
Drought_LT_matrix<-dplyr::select(Drought_LT_matrix,water_year,Taxlifestage,BPUE_ug)
Drought_LT_matrix<-Drought_LT_matrix%>%
rbind(taxa)
Drought_LT_matrix<-Drought_LT_matrix%>%filter(water_year<2021)
Drought_LT_matrix$BPUE_ug[Drought_LT_matrix$BPUE_ug == 0] <- NA
Drought_LT_matrix<-Drought_LT_matrix%>%pivot_wider(names_from=Taxlifestage,values_from=BPUE_ug)
write.csv(Drought_LT_matrix,"Outputs/Drought_taxa_BPUEmatrix.csv",row.names = F)
taxa<-taxa%>%group_by(water_year,Taxlifestage)%>%
dplyr::summarise(BPUE_ug=mean(BPUE_ug))%>%filter(water_year<2021)
p<-ggplot(taxa,aes(water_year,BPUE_ug,fill=Taxlifestage))+
geom_bar(stat="identity")
p
ggsave("Figures/DROUGHT_BPUE_Taxa.png")
